---
import { Image } from 'astro:assets';
import logo from '../assets/images/global/logo-new.webp';
import homeIcon from '../assets/images/navi/navi_home.webp';
import faqIcon from '../assets/images/navi/navi_question.webp';
import toolsIcon from '../assets/images/navi/navi_tools.webp';
import patreonLogo from '../assets/images/navi/patreon.webp';
import subscribedIcon from '../assets/images/navi/subscribed.webp';

const currentPath = Astro.url.pathname;
const isToolsPage = currentPath.startsWith('/tools');
---
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="/" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: var(--spacing-2);">
                <Image src={logo} alt="Codex Helper Logo" class="logo-image" width="120" height="120" loading="eager" quality={100}/>
                <span>Codex Helper</span>
            </a>
        </div>
        <div class="nav-links">
            <a href="/" class:list={["nav-link", { "active": currentPath === "/" }]}>
                <Image src={homeIcon} alt="Home" class="nav-icon" width="60" height="60" loading="eager" quality={100}/>
                <span>Home</span>
            </a>
            <a href="/faq" class:list={["nav-link", { "active": currentPath.startsWith('/faq') }]}>
                <Image src={faqIcon} alt="FAQ" class="nav-icon" width="60" height="60" loading="eager" quality={100}/>
                <span>FAQ</span>
            </a>
            <a href="/tools" class:list={["nav-link", { "active": isToolsPage }]}>
                <Image src={toolsIcon} alt="Tools" class="nav-icon" width="60" height="60" loading="eager" quality={100}/>
                <span>Tools</span>
            </a>

            {isToolsPage ? (
                <div id="auth-container"></div>
            ) : (
                <a href="https://www.patreon.com/c/kingscodex" target="_blank" class="patreon-btn">
                    <Image src={patreonLogo} alt="Patreon Logo" class="patreon-logo" width="90" height="90" loading="eager" quality={100}/>
                    <span>Subscribe</span>
                </a>
            )}
        </div>
    </div>
    
    {isToolsPage && (
        <div class="sub-navbar">
            <div class="sub-nav-container">
                <a href="/tools/mail/" class:list={["sub-nav-link", { "active": currentPath.startsWith('/tools/mail') }]}>Alliance Mail Generator</a>
                <a href="/tools/calculators/" class:list={["sub-nav-link", { "active": currentPath.startsWith('/tools/calculators') }]}>General Calculators</a>
                <a href="/tools/equipment/" class:list={["sub-nav-link", { "active": currentPath.startsWith('/tools/materials') }]}>Equipment Calculators</a>
                <a href="/tools/davor_toolkit/" class:list={["sub-nav-link", { "active": currentPath.startsWith('/tools/davor_toolkit') }]}>Davor's Toolkit</a>
            </div>
        </div>
    )}
</nav>

<script define:vars={{ subscribedIconPath: subscribedIcon.src }}>
    document.addEventListener('auth:loggedIn', (event) => {
        const user = event.detail.user;
        
        if (user && user.is_active_patron) {
            const patreonButton = document.querySelector('.patreon-btn');
            if (patreonButton) {
                patreonButton.removeAttribute('href');
                patreonButton.style.pointerEvents = 'none';
                patreonButton.style.cursor = 'default';
                
                patreonButton.classList.remove('patreon-btn');
                patreonButton.classList.add('subscribed-btn');
                
                const span = patreonButton.querySelector('span');
                if (span) {
                    span.textContent = 'Subscribed!';
                }
                
                const oldIcon = patreonButton.querySelector('img'); 
                if (oldIcon) {
                    const newIcon = document.createElement('img');
                    newIcon.src = subscribedIconPath;
                    newIcon.alt = "Subscribed";
                    newIcon.className = 'subscribed-icon'; 
                    patreonButton.replaceChild(newIcon, oldIcon);
                }
            }
        }
    });
</script>

<style is:global>
    .subscribed-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-2);
        padding: var(--spacing-1) var(--spacing-3);
        border-radius: var(--radius-md);
        font-weight: 500;
        font-size: var(--font-size-sm);
        
        background: rgba(87, 242, 135, 0.25);
        
        border: 1px solid rgba(255, 255, 255, 0.7);
        color: var(--text-primary);

        height: 46px;
    }

    .subscribed-btn:hover {
        transform: none;
        box-shadow: none;
        background: rgba(87, 242, 135, 0.25);
    }
    .subscribed-btn .subscribed-icon {
        height: 28px;
        width: auto;
    }
</style>