---
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import '../../styles/davor_toolkit.css';
import davorIcon from '../../assets/images/davor_toolkit/davor_icon.webp';
import equipmentData from '../../data/equipment.json';

import cavalryIcon from '../../assets/images/materials/troop_icons/cavalry_icon_mini.webp';
import infantryIcon from '../../assets/images/materials/troop_icons/infantry_icon_mini.webp';
import archerIcon from '../../assets/images/materials/troop_icons/archer_icon_mini.webp';
import siegeIcon from '../../assets/images/materials/troop_icons/siege_icon_mini.webp';

const allDavorImageModules = import.meta.glob<any>('../../assets/images/davor_toolkit/**/*.{webp,png,jpg}', { eager: true });
const allCommanderImageModules = import.meta.glob<any>('../../assets/images/davor_toolkit/commanders/*.webp', { eager: true });
const allEquipmentImageModules = import.meta.glob<any>('../../assets/images/materials/equipment/*.webp', { eager: true });


const imagePathMap: { [key: string]: string } = {};

function populateMap(modules: Record<string, any>) {
    for (const path in modules) {
        const filename = path.split('/').pop();
        if (filename) {
            imagePathMap[filename] = modules[path].default.src;
        }
    }
}

populateMap(allDavorImageModules);
populateMap(allCommanderImageModules);
populateMap(allEquipmentImageModules);

const statsWeightingIconPath = imagePathMap['stats_icon.webp'] || '';
const armamentsIconPath = imagePathMap['armaments_icon.webp'] || davorIcon.src;
const davorIconPath = davorIcon.src; 
---
<Layout title="Davor's Toolkit" bodyClass="has-sub-nav">
    <main class="tool-page-wrapper">
        <section class="tool-hero">
            <div class="tool-hero-container">
                <div class="section-badge">Community Tools</div>
                
                <div class="quick-access-container">
                    <div class="quick-access-nav" id="quick-access-nav"></div>
                </div>
                <h1 id="calculator-main-title" class="calculator-main-title"></h1>
                <p id="calculator-main-description"></p>
            </div>
        </section>

        <section class="tool-content">
            <div class="carousel-container">
                <div class="carousel-track-container">
                    <div class="carousel-track">
                        <div class="carousel-slide" data-title="Stats Weighting" data-description="Analyze the stat weights for different commander pairings and equipment sets to optimize your armaments." data-icon={statsWeightingIconPath}>
                            <div class="calculator-island">
                                <div class="island-content">
                                    <div class="form-group">
                                        <label>Troop Type</label>
                                        <div id="troop-type-selector" class="button-selector">
                                            <button class="selector-btn active" data-type="cavalry"><Image src={cavalryIcon} alt="Cavalry" width="24" height="24"/><span>Cavalry</span></button>
                                            <button class="selector-btn" data-type="infantry"><Image src={infantryIcon} alt="Infantry" width="24" height="24"/><span>Infantry</span></button>
                                            <button class="selector-btn" data-type="archer"><Image src={archerIcon} alt="Archers" width="24" height="24"/><span>Archers</span></button>
                                            <button class="selector-btn" data-type="engineering"><Image src={siegeIcon} alt="Engineering" width="24" height="24"/><span>Engineering</span></button>
                                        </div>
                                    </div>

                                    <div class="selectors-container">
                                        <div class="pairing-selector-wrapper">
                                            <label>Commander Pairing</label>
                                            <div id="pairing-selector" class="pairing-selector"></div>
                                        </div>
                                        <div class="equipment-carousel-wrapper">
                                            <label>Equipment Set</label>
                                            <div id="equipment-set-carousel">
                                                <div id="equipment-display"></div>
                                                <button id="prev-set" class="equipment-arrow">&lt;</button>
                                                <button id="next-set" class="equipment-arrow">&gt;</button>
                                                <div id="pagination-dots"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="result-display" class="stats-result-display" style="display: none;">
                                        <h4 id="stat-weights-title">Stat Weights:</h4>
                                        <p id="stat-weights"></p>
                                    </div>
                                    <div class="form-group-horizontal-power">
                                        <div class="form-group">
                                            <label for="all-damage-input">All Damage (%)</label>
                                            <input type="number" id="all-damage-input" placeholder="Example: 1.5">
                                        </div>
                                        <span class="input-divider">or</span>
                                        <div class="form-group">
                                            <label for="health-input">Health (%)</label>
                                            <input type="number" id="health-input" placeholder="Example: 2.5">
                                        </div>
                                    </div>
                                    <div id="conversion-result" class="calc-result">
                                        <h4 id="conversion-label" class="conversion-label"></h4>
                                        <div id="conversion-output"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="carousel-slide" data-title="Score my Armaments" data-description="A new tool is coming soon to help you score and optimize your armaments." data-icon={armamentsIconPath}>
                            <div class="calculator-island">
                                <div class="island-content coming-soon-content">
                                    <h3>Coming Soon!</h3>
                                    <p>The "Score my Armaments" calculator is under construction.</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <button class="carousel-arrow prev" id="prev-slide"><i class="fas fa-chevron-left"></i></button>
                <button class="carousel-arrow next" id="next-slide"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section class="contributor-section">
            <div class="contributor-container">
                <div class="contributor-box">
                    <div class="contributor-content">
                        <h3>About Davor</h3>
                        <p>Davor is a long-time mathematical ROK player who excels at understanding the true nature of the numbers behind the game we all play. He is one of our <span class="wizard-gradient">Codex Wizards</span> consistently answering questions related to the game and continues to create tools for the community to help optimize their gameplay and get the most of our their accounts.</p>
                    </div>
                    <div class="contributor-actions">
                        <p class="contributor-connect">Contact Davor or find more of his tools and support his work here:</p>
                        <div class="action-item">
                            <span class="action-label">Discord:</span>
                            <div class="action-btn discord-btn">
                                <i class="fa-brands fa-discord"></i>
                                <span>@davor5647</span>
                            </div>
                        </div>
                        <div class="action-item">
                            <span class="action-label">Support Him:</span>
                            <a href="https://buymeacoffee.com/davorrok/davor-s-rok-tools-box" target="_blank" class="action-btn support-btn">
                                <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee">
                                <span>Support Davor</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script define:vars={{ imagePaths: imagePathMap, equipmentData, davorIconPath }}>
        window.DAVOR_IMAGE_PATHS = imagePaths;
        window.equipmentData = equipmentData;
        window.davorIconPath = davorIconPath; 
    </script>
    <script>
        import "../../scripts/davor_toolkit.js";
    </script>
</Layout>