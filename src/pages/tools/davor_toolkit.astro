---
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import '../../styles/davor_toolkit.css';
import davorIcon from '../../assets/images/davor_toolkit/davor_icon.webp';
import equipmentData from '../../data/equipment.json';
import weightingData from '../../data/weighting_data.json';
import scorePairings from '../../data/score_pairings.json';
import inscriptionsData from '../../data/inscriptions.json';
import inscriptionStats from '../../data/inscription_stats.json';

import cavalryIcon from '../../assets/images/materials/troop_icons/cavalry_icon_mini.webp';
import infantryIcon from '../../assets/images/materials/troop_icons/infantry_icon_mini.webp';
import archerIcon from '../../assets/images/materials/troop_icons/archer_icon_mini.webp';
import siegeIcon from '../../assets/images/materials/troop_icons/siege_icon_mini.webp';

const allDavorImageModules = import.meta.glob<any>('../../assets/images/davor_toolkit/**/*.{webp,png,jpg}', { eager: true });
const allCommanderImageModules = import.meta.glob<any>('../../assets/images/davor_toolkit/commanders/*.webp', { eager: true });
const allEquipmentImageModules = import.meta.glob<any>('../../assets/images/materials/equipment/*.webp', { eager: true });


const imagePathMap: { [key: string]: string } = {};

function populateMap(modules: Record<string, any>) {
    for (const path in modules) {
        const filename = path.split('/').pop();
        if (filename) {
            imagePathMap[filename] = modules[path].default.src;
        }
    }
}

populateMap(allDavorImageModules);
populateMap(allCommanderImageModules);
populateMap(allEquipmentImageModules);

const statsWeightingIconPath = imagePathMap['stats_icon.webp'] || '';
const davorIconPath = davorIcon.src;
const davorIconWidth = davorIcon.width;
const davorIconHeight = davorIcon.height;
---
<Layout title="Davor's Toolkit" bodyClass="has-sub-nav">
    <main class="tool-page-wrapper">
        <section class="tool-hero">
            <div class="tool-hero-container">
                <div class="section-badge">Community Tools</div>

                <div class="quick-access-container">
                    <div class="quick-access-nav" id="quick-access-nav"></div>
                </div>
                <h1 id="calculator-main-title" class="calculator-main-title"></h1>
                <p id="calculator-main-description"></p>
            </div>
        </section>

        <section class="tool-content">
            <div class="carousel-container">
                <div class="carousel-track-container">
                    <div class="carousel-track">
                        <div class="carousel-slide" data-title="Stats Weighting" data-description="Analyze the stat weights for different commander pairings and equipment sets to optimize your armaments." data-icon={statsWeightingIconPath}>
                            <div class="calculator-island">
                                <div class="island-content">
                                    <p class="tool-explanation">This tool will help you weight the <span class="wizard-gradient">extra stats</span> that you receive, on top of the existing stats from your commanders and equipment based on the <span class="wizard-gradient">Damage Formula</span> and <span class="wizard-gradient">Combat Effectiveness,</span> which is the improvement of both your <span class="wizard-gradient">damage dealt</span> and <span class="wizard-gradient">damage taken</span>.</p>
                                    <div class="form-group">
                                        <div class="form-label-heading">Troop Type</div>
                                        <div id="troop-type-selector" class="button-selector">
                                            <button class="selector-btn active" data-type="cavalry"><Image loading="eager" src={cavalryIcon} alt="Cavalry" width="24" height="24"/><span>Cavalry</span></button>
                                            <button class="selector-btn" data-type="infantry"><Image loading="eager" src={infantryIcon} alt="Infantry" width="24" height="24"/><span>Infantry</span></button>
                                            <button class="selector-btn" data-type="archer"><Image loading="eager" src={archerIcon} alt="Archers" width="24" height="24"/><span>Archers</span></button>
                                            <button class="selector-btn" data-type="engineering"><Image loading="eager" src={siegeIcon} alt="Engineering" width="24" height="24"/><span>Engineering</span></button>
                                        </div>
                                    </div>

                                    <div class="selectors-container">
                                        <div class="pairing-selector-wrapper">
                                            <div class="form-label-heading">Commander Pairing</div>
                                            <div id="pairing-selector" class="pairing-selector"></div>
                                        </div>
                                        <div class="equipment-carousel-wrapper">
                                            <div class="form-label-heading">Equipment Set</div>
                                            <div id="equipment-set-carousel">
                                                <div id="equipment-display"></div>
                                                <button id="prev-set" class="equipment-arrow">&lt;</button>
                                                <button id="next-set" class="equipment-arrow">&gt;</button>
                                                <div id="pagination-dots"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="result-display" class="stats-result-display" style="display: none;">
                                        <h4 id="stat-weights-title">Stat Weights:</h4>
                                        <p id="stat-weights"></p>
                                    </div>
                                    <div class="form-group-horizontal-power">
                                        <div class="form-group">
                                            <label for="all-damage-input">All Damage (%)</label>
                                            <input type="number" id="all-damage-input" placeholder="Example: 1.5">
                                        </div>
                                        <span class="input-divider">or</span>
                                        <div class="form-group">
                                            <label for="health-input">Health (%)</label>
                                            <input type="number" id="health-input" placeholder="Example: 2.5">
                                        </div>
                                    </div>
                                    <div id="conversion-result" class="calc-result">
                                        <h4 id="conversion-label" class="conversion-label"></h4>
                                        <div id="conversion-output"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="carousel-slide" data-title="Score my Armaments" data-description="Score and optimize your armaments based on pairings, formations, and inscriptions.">
                           <div class="calculator-island">
                                 <div class="island-content">
                                    <div class="generator-tabs">
                                        <button class="generator-tab-btn active" data-tab="armament-tool">Armament Tool</button>
                                        <button class="generator-tab-btn" data-tab="saved-scores">Saved Scores</button>
                                    </div>
                                    <div id="armament-tool-view" class="generator-view active">
                                        <p class="tool-explanation">This tool utilizes a <span class="wizard-gradient">Score System</span> based on <span class="wizard-gradient">scale values</span> for the extra stats that you receive, on top of existing stats from your commanders and equipment. This Score system gives <span class="wizard-gradient">1 point per 1% attack,</span> and relative scoring for other stats, taking into account <span class="wizard-gradient">Bonus/Reduction</span> and <span class="wizard-gradient">Boost/Resistance</span>. The scale of values is based on the <span class="wizard-gradient">Damage Formula</span> and <span class="wizard-gradient">Combat Effectiveness</span>, and takes into consideration the updated <span class="wizard-gradient">Crystal Tech v5.</span> Total scores will allow you to compare two armaments, two inscriptions or even two full sets on a formation.</p>

                                        <div class="form-group">
                                            <div class="form-label-heading">Troop Type</div>
                                            <div id="armament-troop-selector" class="button-selector">
                                                <button class="selector-btn active" data-type="cavalry"><Image loading="eager" src={cavalryIcon} alt="Cavalry" width="24" height="24"/><span>Cavalry</span></button>
                                                <button class="selector-btn" data-type="infantry"><Image loading="eager" src={infantryIcon} alt="Infantry" width="24" height="24"/><span>Infantry</span></button>
                                                <button class="selector-btn" data-type="archer"><Image loading="eager" src={archerIcon} alt="Archers" width="24" height="24"/><span>Archers</span></button>
                                            </div>
                                        </div>

                                        <div class="selectors-container">
                                            <div class="pairing-selector-wrapper">
                                                <div class="form-label-heading">Commander Pairing</div>
                                                <div id="armament-pairing-selector" class="pairing-selector"></div>
                                            </div>
                                            <div id="inscription-selector-wrapper" class="inscription-selector-wrapper">
                                                <div class="form-group">
                                                    <label class="form-label-heading">Formation</label>
                                                    <div id="formation-selector" class="formation-selector"></div>
                                                </div>
                                                <div class="form-group" style="display: flex; flex-direction: column; flex-grow: 1;">
                                                    <label class="form-label-heading">Inscriptions</label>
                                                    <input type="search" id="inscription-search" class="inscription-search" placeholder="Search inscriptions...">
                                                    <div id="inscription-selector" class="inscription-selector">
                                                        <p class="inscription-placeholder">Select a formation to see available inscriptions.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="armaments-bottom-row">
                                            <div class="stat-inputs-grid">
                                                <div class="form-group">
                                                    <label for="armament-attack">Attack (%)</label>
                                                    <input type="number" id="armament-attack" placeholder="10.0">
                                                </div>
                                                <div class="form-group">
                                                    <label for="armament-defense">Defense (%)</label>
                                                    <input type="number" id="armament-defense" placeholder="10.0">
                                                </div>
                                                <div class="form-group">
                                                    <label for="armament-health">Health (%)</label>
                                                    <input type="number" id="armament-health" placeholder="8.0">
                                                </div>
                                                <div class="form-group">
                                                    <label for="armament-all-damage">All Damage (%)</label>
                                                    <input type="number" id="armament-all-damage" placeholder="2.0">
                                                </div>
                                            </div>
                                            <div class="selected-inscriptions-wrapper">
                                                <div class="form-label-heading">Selected Inscriptions</div>
                                                <div id="selected-inscriptions-display">
                                                <p class="inscription-placeholder">No inscriptions selected.</p>
                                                </div>
                                                <p class="inscription-deselect-note">Tap an inscription to de-select it.</p>
                                        </div>
                                        </div>

                                        <div id="armament-score-result" class="calc-result"><span>Select a pairing and formation to calculate your score.</span></div>
                                        <div id="save-score-section" class="save-score-section"></div>
                                        <p class="last-updated-note">Last Updated: November 2025</p>
                                    </div>
                                    <div id="saved-scores-view" class="generator-view">
                                        <div id="saved-scores-header" class="saved-templates-header">
                                            <h2>Your Saved Scores</h2>
                                        </div>
                                        <div id="saved-scores-content">
                                        </div>
                                        <div id="logged-out-overlay-scores" class="logged-out-overlay" style="display: none;">
                                            <div class="logged-out-message">
                                                <h3>Log in to view and manage your saved scores.</h3>
                                                <div id="saved-scores-auth-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="carousel-arrow prev" id="prev-slide"><i class="fas fa-chevron-left"></i></button>
                <button class="carousel-arrow next" id="next-slide"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section class="contributor-section">
            <div class="contributor-container">
                <div class="contributor-box">
                    <div class="contributor-content">
                        <h3>About Davor</h3>
                        <p>Davor is a long-time mathematical ROK player who excels at understanding the true nature of the numbers behind the game we all play. He is one of our <span class="wizard-gradient">Codex Wizards</span> consistently answering questions related to the game and continues to create tools for the community to help optimize their gameplay and get the most of our their accounts.</p>
                    </div>
                    <div class="contributor-actions">
                        <p class="contributor-connect">Contact Davor or find more of his tools and support his work here:</p>
                        <div class="action-item">
                            <span class="action-label">Discord:</span>
                            <div class="action-btn discord-btn">
                                <i class="fa-brands fa-discord"></i>
                                <span>@davor5647</span>
                            </div>
                        </div>
                        <div class="action-item">
                            <span class="action-label">Support Him:</span>
                            <a href="https://buymeacoffee.com/davorrok/davor-s-rok-tools-box" target="_blank" class="action-btn support-btn">
                                <img loading="lazy" src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee">
                                <span>Support Davor</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script define:vars={{ imagePaths: imagePathMap, equipmentData, inscriptionsData, inscriptionStats, davorIconPath, davorIconWidth, davorIconHeight, weightingData, scorePairings }}>
        window.DAVOR_IMAGE_PATHS = imagePaths;
        window.equipmentData = equipmentData;
        window.inscriptionsData = inscriptionsData;
        window.inscriptionStats = inscriptionStats;
        window.davorIconPath = davorIconPath;
        window.davorIconWidth = davorIconWidth;
        window.davorIconHeight = davorIconHeight;
        window.weightingData = weightingData;
        window.scorePairings = scorePairings;
    </script>
    <script>
        import "../../scripts/utils.js";
        import "../../scripts/auth.js";
        import "../../scripts/davor_toolkit.js";
    </script>
</Layout>